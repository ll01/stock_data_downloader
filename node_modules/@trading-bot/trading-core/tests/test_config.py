"""Tests for the config module."""

import pytest
from pydantic import ValidationError
from trading_core.config import (
    ServerConfig, 
    DataSourceConfig, 
    DataSourceType,
    ExchangeConfig, 
    StrategyConfig, 
    MonitoringConfig, 
    AppConfig
)


def test_server_config():
    """Test the ServerConfig class."""
    # Test with default values
    config = ServerConfig()
    assert config.host == "0.0.0.0"
    assert config.port == 8000
    assert config.debug is False
    assert config.log_level == "INFO"
    
    # Test with custom values
    config = ServerConfig(host="127.0.0.1", port=9000, debug=True, log_level="DEBUG")
    assert config.host == "127.0.0.1"
    assert config.port == 9000
    assert config.debug is True
    assert config.log_level == "DEBUG"
    
    # Test validation
    with pytest.raises(ValidationError):
        ServerConfig(log_level="INVALID")


def test_data_source_config():
    """Test the DataSourceConfig class."""
    # Test with minimal required values
    config = DataSourceConfig(type=DataSourceType.YAHOO, tickers=["AAPL", "MSFT"])
    assert config.type == DataSourceType.YAHOO
    assert config.tickers == ["AAPL", "MSFT"]
    assert config.interval == "1d"
    assert config.api_key is None
    assert config.api_secret is None
    assert config.backtest_file is None
    
    # Test with all values
    config = DataSourceConfig(
        type=DataSourceType.BINANCE,
        tickers=["BTCUSDT", "ETHUSDT"],
        interval="4h",
        api_key="api_key",
        api_secret="api_secret",
        backtest_file="data.csv"
    )
    assert config.type == DataSourceType.BINANCE
    assert config.tickers == ["BTCUSDT", "ETHUSDT"]
    assert config.interval == "4h"
    assert config.api_key == "api_key"
    assert config.api_secret == "api_secret"
    assert config.backtest_file == "data.csv"
    
    # Test validation
    with pytest.raises(ValidationError):
        DataSourceConfig(type=DataSourceType.YAHOO, tickers=["AAPL"], interval="invalid")


def test_exchange_config():
    """Test the ExchangeConfig class."""
    # Test with minimal required values
    config = ExchangeConfig(name="binance")
    assert config.name == "binance"
    assert config.api_key is None
    assert config.api_secret is None
    assert config.testnet is True
    assert config.rate_limit == 5
    
    # Test with all values
    config = ExchangeConfig(
        name="binance",
        api_key="api_key",
        api_secret="api_secret",
        testnet=False,
        rate_limit=10
    )
    assert config.name == "binance"
    assert config.api_key == "api_key"
    assert config.api_secret == "api_secret"
    assert config.testnet is False
    assert config.rate_limit == 10
    
    # Test validation
    with pytest.raises(ValidationError):
        ExchangeConfig(name="binance", rate_limit=0)


def test_strategy_config():
    """Test the StrategyConfig class."""
    # Test with minimal required values
    config = StrategyConfig(name="mean_reversion", parameters={})
    assert config.name == "mean_reversion"
    assert config.parameters == {}
    
    # Test with parameters
    config = StrategyConfig(
        name="mean_reversion",
        parameters={
            "entry_threshold": 2.0,
            "exit_threshold": 0.5,
            "stop_loss": 0.05,
            "use_trailing_stop": True,
            "max_positions": 5
        }
    )
    assert config.name == "mean_reversion"
    assert config.parameters["entry_threshold"] == 2.0
    assert config.parameters["exit_threshold"] == 0.5
    assert config.parameters["stop_loss"] == 0.05
    assert config.parameters["use_trailing_stop"] is True
    assert config.parameters["max_positions"] == 5


def test_monitoring_config():
    """Test the MonitoringConfig class."""
    # Test with default values
    config = MonitoringConfig()
    assert config.zmq_host == "localhost"
    assert config.zmq_port == 5557
    assert config.enabled is True
    assert config.log_trades is True
    assert config.log_stats_interval == 60
    
    # Test with custom values
    config = MonitoringConfig(
        zmq_host="192.168.1.100",
        zmq_port=6000,
        enabled=False,
        log_trades=False,
        log_stats_interval=120
    )
    assert config.zmq_host == "192.168.1.100"
    assert config.zmq_port == 6000
    assert config.enabled is False
    assert config.log_trades is False
    assert config.log_stats_interval == 120
    
    # Test validation
    with pytest.raises(ValidationError):
        MonitoringConfig(zmq_port=80)  # Below 1024
    
    with pytest.raises(ValidationError):
        MonitoringConfig(log_stats_interval=0)  # Must be positive


def test_app_config():
    """Test the AppConfig class."""
    # Create component configs
    server_config = ServerConfig(host="127.0.0.1", port=9000)
    data_source_config = DataSourceConfig(type=DataSourceType.YAHOO, tickers=["AAPL", "MSFT"])
    exchange_config = ExchangeConfig(name="binance")
    strategy_config = StrategyConfig(name="mean_reversion", parameters={"entry_threshold": 2.0})
    monitoring_config = MonitoringConfig(zmq_host="localhost", zmq_port=5557)
    
    # Create app config
    config = AppConfig(
        server=server_config,
        data_sources={"yahoo": data_source_config},
        exchanges={"binance": exchange_config},
        strategies={"mean_reversion": strategy_config},
        monitoring=monitoring_config
    )
    
    # Verify attributes
    assert config.server.host == "127.0.0.1"
    assert config.server.port == 9000
    assert config.data_sources["yahoo"].type == DataSourceType.YAHOO
    assert config.data_sources["yahoo"].tickers == ["AAPL", "MSFT"]
    assert config.exchanges["binance"].name == "binance"
    assert config.strategies["mean_reversion"].name == "mean_reversion"
    assert config.strategies["mean_reversion"].parameters["entry_threshold"] == 2.0
    assert config.monitoring.zmq_host == "localhost"
    assert config.monitoring.zmq_port == 5557


def test_config_validation():
    """Test configuration validation."""
    # Test that extra fields are not allowed
    with pytest.raises(ValidationError):
        AppConfig(
            server=ServerConfig(),
            data_sources={"yahoo": DataSourceConfig(type=DataSourceType.YAHOO, tickers=["AAPL"])},
            exchanges={"binance": ExchangeConfig(name="binance")},
            strategies={"mean_reversion": StrategyConfig(name="mean_reversion", parameters={})},
            monitoring=MonitoringConfig(),
            extra_field="This should not be allowed"
        )
    
    # Test nested validation
    with pytest.raises(ValidationError):
        AppConfig(
            server=ServerConfig(log_level="INVALID"),  # Invalid log level
            data_sources={"yahoo": DataSourceConfig(type=DataSourceType.YAHOO, tickers=["AAPL"])},
            exchanges={"binance": ExchangeConfig(name="binance")},
            strategies={"mean_reversion": StrategyConfig(name="mean_reversion", parameters={})},
            monitoring=MonitoringConfig()
        )