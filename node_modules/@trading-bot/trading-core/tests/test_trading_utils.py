"""Tests for the utils module."""

import pytest
from datetime import timedelta
from trading_core.utils import parse_interval_string, is_valid_ticker, format_price


def test_parse_interval_string():
    """Test the parse_interval_string function."""
    # Test minutes
    assert parse_interval_string("1m") == timedelta(minutes=1)
    assert parse_interval_string("5m") == timedelta(minutes=5)
    assert parse_interval_string("30m") == timedelta(minutes=30)
    
    # Test hours
    assert parse_interval_string("1h") == timedelta(hours=1)
    assert parse_interval_string("4h") == timedelta(hours=4)
    assert parse_interval_string("24h") == timedelta(hours=24)
    
    # Test days
    assert parse_interval_string("1d") == timedelta(days=1)
    assert parse_interval_string("7d") == timedelta(days=7)
    
    # Test weeks
    assert parse_interval_string("1w") == timedelta(weeks=1)
    assert parse_interval_string("2w") == timedelta(weeks=2)
    
    # Test months (approximated as 30 days)
    assert parse_interval_string("1M") == timedelta(days=30)
    assert parse_interval_string("3M") == timedelta(days=90)
    
    # Test case insensitivity
    assert parse_interval_string("1D") == timedelta(days=1)
    assert parse_interval_string("1H") == timedelta(hours=1)
    
    # Test invalid formats
    with pytest.raises(ValueError):
        parse_interval_string("invalid")
    
    with pytest.raises(ValueError):
        parse_interval_string("1")
    
    with pytest.raises(ValueError):
        parse_interval_string("m1")
    
    with pytest.raises(ValueError):
        parse_interval_string("1x")


def test_is_valid_ticker():
    """Test the is_valid_ticker function."""
    # Test valid tickers
    assert is_valid_ticker("AAPL") is True
    assert is_valid_ticker("BTC-USD") is True
    assert is_valid_ticker("SPY.AX") is True
    assert is_valid_ticker("ETH_USDT") is True
    assert is_valid_ticker("a") is True
    assert is_valid_ticker("123") is True
    
    # Test invalid tickers
    assert is_valid_ticker("") is False
    assert is_valid_ticker(None) is False
    assert is_valid_ticker("AAPL MSFT") is False  # Contains space
    assert is_valid_ticker("AAPL!") is False  # Contains special character
    assert is_valid_ticker("$SPY") is False  # Contains special character


def test_format_price():
    """Test the format_price function."""
    # Test with default decimals (2)
    assert format_price(123.456) == "123.46"
    assert format_price(123) == "123.00"
    assert format_price(0) == "0.00"
    assert format_price(0.1) == "0.10"
    
    # Test with custom decimals
    assert format_price(123.456, decimals=0) == "123"
    assert format_price(123.456, decimals=1) == "123.5"
    assert format_price(123.456, decimals=3) == "123.456"
    assert format_price(123.456, decimals=4) == "123.4560"
    
    # Test with negative numbers
    assert format_price(-123.456, decimals=2) == "-123.46"
    
    # Test with invalid input
    with pytest.raises(ValueError):
        format_price("123.45")
    
    with pytest.raises(ValueError):
        format_price(None)