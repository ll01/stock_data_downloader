import os
import socket
import time
import datetime
from typing import Any, Dict, Optional

import zmq


class MetricsPublisher:
    """
    A reusable ZMQ metrics publisher for trading bot monitoring.
    Wraps PUB socket setup and sending logic in a consistent API.
    """

    def __init__(self, zmq_host: Optional[str] = None, zmq_port: Optional[int] = None, service: str = "unknown", version: str = "v1"):
        self.context = zmq.Context.instance()
        self.socket = self.context.socket(zmq.PUB)

        # Prefer host/port over URL if provided
        if zmq_host and zmq_port:
            self.address = f"tcp://{zmq_host}:{zmq_port}"
        else:
            self.address = zmq_host or os.getenv("METRICS_ZMQ_URL", "tcp://localhost:5559")

        self.socket.connect(self.address)
        self.service = service
        self.version = version
        self.instance_id = os.getenv("SERVICE_INSTANCE_ID", socket.gethostname())
        self.last_heartbeat: Optional[datetime.datetime] = None

    def publish(self, topic: str, data: Dict[str, Any]) -> None:
        """
        Send JSON metric payload to specified topic.
        :param topic: Short topic name (e.g. 'trades', 'cointegration').
        """
        ts = int(time.time())
        envelope = {
            "version": self.version,
            "service": self.service,
            "instance": self.instance_id,
            "ts": ts,
            "data": data,
        }
        full_topic = f"metrics.{self.version}.{self.service}.{topic}"
        try:
            self.socket.send_string(full_topic, zmq.SNDMORE)
            self.socket.send_json(envelope)
        except Exception as e:
            print(f"[MetricsPublisher] Failed to send message on {full_topic}: {e}")

    def send_heartbeat(self):
        """Send a heartbeat message to verify channel is alive."""
        self.last_heartbeat = datetime.datetime.utcnow()
        self.publish("heartbeat", {"timestamp": self.last_heartbeat.isoformat()})
    
    def close(self):
        """Clean up ZMQ resources."""
        try:
            if self.socket:
                self.socket.close()
            if self.context:
                self.context.term()
        except Exception as e:
            print(f"[MetricsPublisher] Error during cleanup: {e}")