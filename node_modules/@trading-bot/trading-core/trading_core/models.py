"""
Shared data models and configuration for trading applications.

This module contains:
- Configuration models (Pydantic BaseModel)
- Data classes for trading domain
- Common utilities models
"""

from dataclasses import dataclass
from datetime import datetime
from typing import List, Optional, Union, Dict, Any
from pydantic import BaseModel, Field, field_validator, ConfigDict
import re
from enum import Enum

# ===================================================================
# Configuration Models (from common)
# ===================================================================

class HestonConfig(BaseModel):
    kappa: float
    theta: float
    xi: float
    rho: float

class GBMConfig(BaseModel):
    mean: float
    sd: float

class TickerConfig(BaseModel):
    heston: Optional[HestonConfig] = None
    gbm: Optional[GBMConfig] = None

class TickerData(BaseModel):
    ticker: str
    price: float
    timestamp: float
    volume: float

# ===================================================================
# Configuration Models (from trading-core/config.py)
# ===================================================================

class DataSourceType(str, Enum):
    """Enum for data source types."""
    YAHOO = "yahoo"
    BINANCE = "binance"
    HYPERLIQUID = "hyperliquid"
    BACKTEST = "backtest"


class ServerConfig(BaseModel):
    """
    Configuration for server components.

    Attributes:
        host: The server host address
        port: The server port
        debug: Whether to run in debug mode
        log_level: The logging level
    """
    host: str = "0.0.0.0"
    port: int = 8000
    debug: bool = False
    log_level: str = "INFO"
    
    @field_validator('log_level')
    @classmethod
    def validate_log_level(cls, v):
        """Validate that the log level is valid."""
        valid_levels = ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"]
        if v not in valid_levels:
            raise ValueError(f"Log level must be one of {valid_levels}")
        return v


class DataSourceConfig(BaseModel):
    """
    Configuration for data sources.

    Attributes:
        type: The type of data source
        tickers: List of ticker symbols
        interval: The data interval (e.g., '1d', '4h', '30m')
        api_key: Optional API key for authenticated sources
        api_secret: Optional API secret for authenticated sources
        backtest_file: Optional path to backtest data file
    """
    type: DataSourceType
    tickers: List[str]
    interval: str = "1d"
    api_key: Optional[str] = None
    api_secret: Optional[str] = None
    backtest_file: Optional[str] = None
    
    @field_validator('interval')
    @classmethod
    def validate_interval(cls, v):
        """Validate that the interval is in the correct format."""
        if not re.match(r'^\d+[mhdwM]$', v):
            raise ValueError("Interval must be in format like '1m', '4h', '1d', '1w', '1M'")
        return v


class ExchangeConfig(BaseModel):
    """
    Configuration for exchange connections.

    Attributes:
        name: The exchange name
        api_key: Optional API key for authenticated access
        api_secret: Optional API secret for authenticated access
        testnet: Whether to use the testnet/sandbox environment
        rate_limit: Rate limit in requests per second
    """
    name: str
    api_key: Optional[str] = None
    api_secret: Optional[str] = None
    testnet: bool = True
    rate_limit: int = 5  # requests per second
    
    @field_validator('rate_limit')
    @classmethod
    def validate_rate_limit(cls, v):
        """Validate that the rate limit is positive."""
        if v <= 0:
            raise ValueError("Rate limit must be positive")
        return v


class StrategyConfig(BaseModel):
    """
    Configuration for trading strategies.

    Attributes:
        name: The strategy name
        parameters: Dictionary of strategy parameters
    """
    name: str
    parameters: Dict[str, Union[str, int, float, bool]]


class MonitoringConfig(BaseModel):
    """
    Configuration for monitoring components.

    Attributes:
        zmq_host: The ZMQ host address
        zmq_port: The ZMQ port for monitoring
        enabled: Whether monitoring is enabled
        log_trades: Whether to log trades
        log_stats_interval: Interval for logging statistics in seconds
    """
    zmq_host: str = "localhost"
    zmq_port: int = 5557
    enabled: bool = True
    log_trades: bool = True
    log_stats_interval: int = 60  # seconds
    
    @field_validator('zmq_port')
    @classmethod
    def validate_zmq_port(cls, v):
        """Validate that the ZMQ port is in a valid range."""
        if not (1024 <= v <= 65535):
            raise ValueError("ZMQ port must be between 1024 and 65535")
        return v
    
    @field_validator('log_stats_interval')
    @classmethod
    def validate_log_stats_interval(cls, v):
        """Validate that the log stats interval is positive."""
        if v <= 0:
            raise ValueError("Log stats interval must be positive")
        return v


class AppConfig(BaseModel):
    """
    Main configuration class that combines all configurations.

    Attributes:
        server: Server configuration
        data_sources: Dictionary of data source configurations
        exchanges: Dictionary of exchange configurations
        strategies: Dictionary of strategy configurations
        monitoring: Monitoring configuration
    """
    server: ServerConfig
    data_sources: Dict[str, DataSourceConfig]
    exchanges: Dict[str, ExchangeConfig]
    strategies: Dict[str, StrategyConfig]
    monitoring: MonitoringConfig
    
    model_config = ConfigDict(extra="forbid")  # Forbid extra attributes

# ===================================================================
# Trading Domain Models
# ===================================================================
@dataclass
class CandleData:
    """
    Represents OHLCV (Open, High, Low, Close, Volume) candle data.
    
    Extracted from pair_trader_experiment/data/models.py
    
    Attributes:
        timestamp: The timestamp of the candle (datetime or string)
        ticker: The ticker symbol
        open: The opening price
        high: The highest price during the period
        low: The lowest price during the period
        close: The closing price
        volume: The trading volume (optional, defaults to 0.0)
    """
    timestamp: Union[datetime, str]
    ticker: str
    open: float
    high: float
    low: float
    close: float
    volume: float = 0.0


@dataclass
class Trade:
    """
    Represents a trade execution.
    
    Extracted from pair_trader_experiment/data/models.py
    
    Attributes:
        pair_id: The ID of the trading pair
        id: Optional trade ID
        ticker: The ticker symbol
        quantity: The quantity traded
        price: The execution price
        side: The trade side ('buy' or 'sell')
        timestamp: The timestamp of the trade (datetime or string)
        closed: Whether the trade is closed
    """
    pair_id: int
    id: Optional[str] = None
    ticker: Optional[str] = None
    quantity: Optional[float] = None
    price: Optional[float] = None
    side: Optional[str] = None
    timestamp: Optional[Union[datetime, str]] = None
    closed: bool = False


@dataclass
class PairData:
    """
    Represents cointegrated pair information.
    
    Extracted from pair_trader_experiment/data/models.py and enhanced
    for cointegration analysis.
    
    Attributes:
        ticker1: The first ticker symbol
        ticker2: The second ticker symbol
        cointegration_score: The cointegration score
        p_value: The p-value from the cointegration test
        half_life: The half-life of mean reversion
        correlation: The correlation between the two tickers
        created_at: The timestamp when this pair was identified
        p1: Price data for the first ticker (optional)
        p2: Price data for the second ticker (optional)
        id: Unique identifier for the pair (optional)
    """
    ticker1: str
    ticker2: str
    cointegration_score: float
    p_value: float
    half_life: float
    correlation: float
    created_at: datetime = datetime.now()
    p1: Optional[List[float]] = None
    p2: Optional[List[float]] = None
    id: Optional[str] = None


@dataclass
class TickerStats:
    """
    Represents statistical data for a ticker.
    
    Extracted from stock_data_downloader/data_processing/TickerStats.py
    and enhanced with additional fields.
    
    Attributes:
        ticker: The ticker symbol
        mean: The mean price
        std_dev: The standard deviation of price
        min: The minimum price (optional)
        max: The maximum price (optional)
        last_price: The last observed price (optional)
        last_updated: The timestamp of the last update (optional)
        kappa: Heston model parameter (mean reversion speed)
        theta: Heston model parameter (long-term variance)
        xi: Heston model parameter (volatility of volatility)
        rho: Heston model parameter (correlation between price and volatility)
        omega: GARCH model parameter
        alpha: GARCH model parameter
        beta: GARCH model parameter
        initial_variance: GARCH model parameter
        degrees_of_freedom: For t-distribution (fat tails)
    """
    ticker: str
    mean: float
    std_dev: float  # Standard deviation of price
    min: Optional[float] = None
    max: Optional[float] = None
    last_price: Optional[float] = None
    last_updated: Optional[datetime] = None
    # Heston Model parameters
    kappa: Optional[float] = None
    theta: Optional[float] = None
    xi: Optional[float] = None
    rho: Optional[float] = None
    # GARCH Model parameters
    omega: Optional[float] = None
    alpha: Optional[float] = None
    beta: Optional[float] = None
    initial_variance: Optional[float] = None
    # For t-distribution (fat tails)
    degrees_of_freedom: Optional[float] = None