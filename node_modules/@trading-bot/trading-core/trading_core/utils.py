"""
Shared utility functions for trading applications.

This module contains utility functions used across multiple trading applications:
- parse_interval_string: Parses time interval strings
- is_valid_ticker: Validates ticker symbols
- format_price: Formats price values for display
"""

import re
from datetime import timedelta
from typing import Union


def parse_interval_string(interval_str: str) -> timedelta:
    """
    Parse a time interval string into a time delta.
    
    Args:
        interval_str: A string representing a time interval (e.g., '1d', '4h', '30m', '1w', '1M')
        
    Returns:
        Time delta corresponding to the interval
        
    Raises:
        ValueError: If the string format is invalid.
    """
    # Use a regular expression to capture the number and the unit (m, h, d, w, M)
    # Case-insensitive matching for units
    match = re.match(r"(\d+)([mhdwM])", interval_str, re.IGNORECASE)

    if not match:
        raise ValueError(
            f"Invalid interval format: '{interval_str}'. "
            "Use format like '1m', '15m', '1h', '1d', '1w', '1M'."
        )

    value, unit = match.groups()
    value = int(value)

    # Handle uppercase 'M' for months first, before lowercasing
    if unit == 'M':
        return timedelta(days=value * 30)

    # Convert to lowercase for other units
    unit = unit.lower()

    if unit == 'm':
        return timedelta(minutes=value)
    elif unit == 'h':
        return timedelta(hours=value)
    elif unit == 'd':
        return timedelta(days=value)
    elif unit == 'w':
        return timedelta(weeks=value)
    else:
        # This case should not be reached due to the regex, but it's good practice
        raise ValueError(f"Unknown interval unit: '{unit}'")


def is_valid_ticker(ticker: str) -> bool:
    """
    Validate a ticker symbol.
    
    Args:
        ticker: The ticker symbol to validate
        
    Returns:
        True if the ticker is valid, False otherwise
    """
    # Basic validation: ticker should be non-empty and contain only alphanumeric characters,
    # dots, hyphens, and underscores
    if not ticker or not isinstance(ticker, str):
        return False
    
    return bool(re.match(r'^[A-Za-z0-9._-]+$', ticker))


def format_price(price: Union[float, int], decimals: int = 2) -> str:
    """
    Format a price value for display.
    
    Args:
        price: The price value to format
        decimals: The number of decimal places to include
        
    Returns:
        Formatted price string
    """
    if not isinstance(price, (float, int)):
        raise ValueError("Price must be a number")
    
    return f"{price:.{decimals}f}"